#!/usr/bin/env php
<?php
use Aplia\Support\Arr;
use \eZCLI;
use \eZScript;
use Aplia\Content\ContentType;
use Aplia\Content\ContentObject;

@include_once 'config.php';
require_once 'autoload.php';

set_time_limit(0);

$cli = \eZCLI::instance();
$script = \eZScript::instance(
    array(
        'description' =>
            "Export content-objects and referenced definitions",
        'use-session' => false,
        'use-modules' => true,
        'use-extensions' => true,
    )
);
$script->startup();
$options = $script->getOptions("[format:][preamble][use-namespace][class:][parent-node:][depth:][exclude-parent][only-visible][file-storage:][include-relations][include-embeds][include-owners][include-parents][no-exclude-top-nodes][exclude-node:*][summary]", "", array(
    "format" => "Type of format, choose between json, ndjson, php and line",
    "class" => "Limit search of objects to only these type of content-classes. Comma separated list",
    "parent-node" => "Choose starting point for export, defaults to root-node 1. Specifiy either node ID, node:<id>, object:<id> or path:<alias-path>",
    "depth" => "Choose how deep in the tree structure to search, defaults to 1 level. Use * for unlimited",
    "exclude-parent" => "Exclude the parent node from the export, the result is then only the child/sub-nodes",
    "exclude-node" => "Excluded specific node from export, can be used multiple times",
    "no-exclude-top-nodes" => "Turn off exclusion of top-level nodes",
    "only-visible" => "Only export visible nodes",
    "file-storage" => "Store file content in specified folder, instead of embedding as base64 in export.",
    'include-relations' => 'Include all objects which are related in export',
    'include-embeds' => 'Include all objects which are embedded in export',
    'include-owners' => 'Include objects for all owners',
    'include-parents' => 'Include all parents of objects',
    "preamble" => "Whether to include preamble when exporting php (php format only)",
    "use-namespace" => "Whether to include ContentType namespace use statement (php format only)",
    "summary" => "Include commented summary at the end (php format only)",
));
$script->initialize();

function underscoreToCamelCase($string)
{
    $str = str_replace(' ', '', ucwords(str_replace('_', " ", $string)));
    $str = lcfirst($str);
    return $str;
}

function indentTextLines($text, $indentation=4, $first=true)
{
    $indentText = str_repeat(" ", $indentation);
    $lines = preg_split("/\r\n|\r|\n/", $text);
    if (!$first) {
        $firstLine = array_shift($lines);
    }
    $lines = array_map(function ($item) use ($indentText) { return $indentText . $item; }, $lines);
    if (!$first) {
        array_unshift($lines, $firstLine);
    }
    return implode("\n", $lines);
}

function commentTextLines($text, $first=true)
{
    $commentText = '//';
    $lines = preg_split("/\r\n|\r|\n/", $text);
    if (!$first) {
        $firstLine = array_shift($lines);
    }
    $lines = array_map(function ($item) use ($commentText) { return $commentText . $item; }, $lines);
    if (!$first) {
        array_unshift($lines, $firstLine);
    }
    return implode("\n", $lines);
}

$supportedFormats = array('line', 'json', 'ndjson', 'php');
$classNames = Arr::get($options, 'class');
if ($classNames) {
    $classNames = explode(",", $classNames);
} else {
    $classNames = null;
}
$depth = Arr::get($options, 'depth');
$depthChoice = $depth;
if ($depth === null || $depth === '') {
    // Default to depth 1 as it is the safest
    $depth = 1;
    $depthChoice = $depth;
} else if ($depth === '*') {
    $depth = null;
    $depthChoice = '*';
} else if (is_numeric($depth) && $depth >= 0) {
    $depth = (int)$depth;
    $depthChoice = $depth;
} else {
    $script->shutdown(1, "--depth must be a positive integer or * for unlimited depth");
}
$includeParent = true;
if (Arr::get($options,'exclude-parent')) {
    $includeParent = false;
}
$includeRelations = false;
if (Arr::get($options,'include-relations')) {
    $includeRelations = true;
}
$includeEmbeds = false;
if (Arr::get($options,'include-embeds')) {
    $includeEmbeds = true;
}
$includeOwners = false;
if (Arr::get($options,'include-owners')) {
    $includeOwners = true;
}
$includeParents = false;
if (Arr::get($options,'include-parents')) {
    $includeParents = true;
}
$includeTopNodes = false;
if (Arr::get($options,'no-exclude-top-nodes')) {
    $includeTopNodes = true;
}
$excludedNodes = array();
if (Arr::get($options, 'exclude-node')) {
    foreach ($options['exclude-node'] as $excludeNode) {
        $nodeMatch = decodeNodeUuid($excludeNode);
        if ($nodeMatch === null) {
            $script->shutdown(1,"No node found for match ${excludeNode}");
        }
        list($matchType, $matchNodeUuid, $matchNodeId) = $nodeMatch;
        $excludedNodes[$matchNodeUuid] = true;
    }
}
// By default we include top-level nodes from exclusion, unless told to include them
if (!$includeTopNodes) {
    $contentNode = eZContentObjectTreeNode::fetch(ContentObject::mapTreeIdentifierToNode('content'));
    $usersNode = eZContentObjectTreeNode::fetch(ContentObject::mapTreeIdentifierToNode('users'));
    $mediaNode = eZContentObjectTreeNode::fetch(ContentObject::mapTreeIdentifierToNode('media'));
    $excludedNodes[$contentNode->attribute('remote_id')] = true;
    $excludedNodes[$usersNode->attribute('remote_id')] = true;
    $excludedNodes[$mediaNode->attribute('remote_id')] = true;
}
$parentNodeId = Arr::get($options, 'parent-node');
$onlyVisible = false;
if (Arr::get($options, 'only-visible')) {
    $onlyVisible = true;
}
$phpPreamble = false;
if (Arr::get($options, 'preamble')) {
    $phpPreamble = true;
}
$useNamespace = false;
if (Arr::get($options, 'use-namespace')) {
    $useNamespace = true;
}
$summary = false;
if (Arr::get($options, 'summary')) {
    $summary = true;
}
$fileStorage = Arr::get($options, 'file-storage');
$languages = null;
$format = Arr::get($options, 'format');
if (!$format) {
    $format = 'json';
} else if (!in_array($format, $supportedFormats)) {
    $script->shutdown(1, "Unsupported format '$format', choose from: " . implode(", ", $supportedFormats));
}

if (!class_exists('Aplia\\Content\\Query\\QuerySet')) {
    $script->shutdown(1, "Please install composer package aplia/query");
}

// Reset current language list to include content languages defined in database
$allLanguages = array_map(function ($lang) { return $lang->attribute('locale'); }, eZContentLanguage::fetchList());
eZContentLanguage::setPrioritizedLanguages($allLanguages);

function decodeNodeUuid($text)
{
    if (is_numeric($text)) {
        $node = \eZContentObjectTreeNode::fetch($text);
        if (!$node) {
            return null;
        }
        return array('node_id', $node->attribute('remote_id'), $node->attribute('node_id'));
    } else if (preg_match("/^(ez)?node:([0-9]+)$/", $text, $matches)) {
        $text = $matches[2];
        $node = \eZContentObjectTreeNode::fetch($text);
        if (!$node) {
            return null;
        }
        return array('node_id', $node->attribute('remote_id'), $node->attribute('node_id'));
    } else if (preg_match("/^(ez)?node_uuid:([a-f0-9-]+)$/i", $text, $matches)) {
        $nodeUuid = strtolower(str_replace("-", "", $matches[2]));
        $node = \eZContentObjectTreeNode::fetchByRemoteID($nodeUuid);
        if (!$node) {
            return null;
        }
        return array('node_uuid', $node->attribute('remote_id'), $node->attribute('node_id'));
    } else if (preg_match("/^(ez)?object:([0-9]+)$/", $text, $matches)) {
        $objectId = $matches[2];
        $object = \eZContentObject::fetch($objectId);
        if (!$object) {
            return null;
        }
        $node = $object->mainNode();
        if (!$node) {
            return null;
        }
        return array('object_id', $node->attribute('remote_id'), $node->attribute('node_id'));
    } else if (preg_match("/^(ez)?object_uuid:([a-f0-9-]+)$/i", $text, $matches)) {
        $objectUuid = strtolower(str_replace("-", "", $matches[2]));
        $object = \eZContentObject::fetchByRemoteID($objectUuid);
        if (!$object) {
            return null;
        }
        $node = $object->mainNode();
        if (!$node) {
            return null;
        }
        return array('object_uuid', $node->attribute('remote_id'), $node->attribute('node_id'));
    } else if (preg_match("/^path:(.+)$/", $text, $matches)) {
        $path = $matches[1];
        $nodeId = \eZURLAliasML::fetchNodeIDByPath($path);
        if (!$nodeId) {
            return null;
        }
        $node = \eZContentObjectTreeNode::fetch($nodeId);
        if (!$node) {
            return null;
        }
        return array('path', $node->attribute('remote_id'), $node->attribute('node_id'));
    } else if ($text) {
        $path = $text;
        $nodeId = \eZURLAliasML::fetchNodeIDByPath($path);
        if (!$nodeId) {
            return null;
        }
        $node = \eZContentObjectTreeNode::fetch($nodeId);
        if (!$node) {
            return null;
        }
        return array('path', $node->attribute('remote_id'), $node->attribute('node_id'));
    } else {
        $node = \eZContentObjectTreeNode::fetch(1);
        if (!$node) {
            return null;
        }
        return array('node_id', $node->attribute('remote_id'), $node->attribute('node_id'));
    }
}

$parentNode = null;
if (is_numeric($parentNodeId)) {
    $parentNode = \eZContentObjectTreeNode::fetch($parentNodeId);
    if (!$parentNode) {
        $script->shutdown(1, "Parent node $parentNodeId does not exist");
    }
} else if (preg_match("/^(ez)?node:([0-9]+)$/", $parentNodeId, $matches)) {
    $parentNodeId = $matches[2];
    $parentNode = \eZContentObjectTreeNode::fetch($parentNodeId);
    if (!$parentNode) {
        $script->shutdown(1, "Parent node $parentNodeId does not exist");
    }
} else if (preg_match("/^(ez)?node_uuid:([a-f0-9-]+)$/i", $parentNodeId, $matches)) {
    $parentNodeUuid = strtolower(str_replace("-", "", $matches[2]));
    $parentNode = \eZContentObjectTreeNode::fetchByRemoteID($parentNodeUuid);
    if (!$parentNode) {
        $script->shutdown(1, "Parent node with UUID $parentNodeUuid does not exist");
    }
} else if (preg_match("/^(ez)?object:([0-9]+)$/", $parentNodeId, $matches)) {
    $parentObjectId = $matches[2];
    $parentObject = \eZContentObject::fetch($parentObjectId);
    if (!$parentObject) {
        $script->shutdown(1, "Parent object $parentObjectId does not exist");
    }
    $parentNode = $parentObject->mainNode();
    if (!$parentNode) {
        $script->shutdown(1, "Parent object $parentObjectId does not have main-node");
    }
    $parentNodeId = $parentNode->attribute('node_id');
} else if (preg_match("/^(ez)?object_uuid:([a-f0-9-]+)$/i", $parentNodeId, $matches)) {
    $parentObjectUuid = strtolower(str_replace("-", "", $matches[2]));
    $parentObject = \eZContentObject::fetchByRemoteID($parentObjectUuid);
    if (!$parentObject) {
        $script->shutdown(1, "Parent object with UUID $parentObjectUuid does not exist");
    }
    $parentNode = $parentObject->mainNode();
    if (!$parentNode) {
        $script->shutdown(1, "Parent object with UUID $parentObjectUuid does not have main-node");
    }
    $parentNodeId = $parentNode->attribute('node_id');
} else if (preg_match("/^path:(.+)$/", $parentNodeId, $matches)) {
    $parentPath = $matches[1];
    $parentNodeId = \eZURLAliasML::fetchNodeIDByPath($parentPath);
    if (!$parentNodeId) {
        $script->shutdown(1, "Parent node with path $parentPath does not exist");
    }
    $parentNode = \eZContentObjectTreeNode::fetch($parentNodeId);
    if (!$parentNode) {
        $script->shutdown(1, "Parent node $parentNodeId for path $parentPath does not exist");
    }
} else if ($parentNodeId) {
    $parentPath = $parentNodeId;
    $parentNodeId = \eZURLAliasML::fetchNodeIDByPath($parentPath);
    if (!$parentNodeId) {
        $script->shutdown(1, "Parent node with path $parentPath does not exist");
    }
    $parentNode = \eZContentObjectTreeNode::fetch($parentNodeId);
    if (!$parentNode) {
        $script->shutdown(1, "Parent node $parentNodeId for path $parentPath does not exist");
    }
} else {
    $parentNode = \eZContentObjectTreeNode::fetch(1);
}

$options = array(
    'start_depth' => 0,
    'include_relations' => $includeRelations,
    'include_embeds' => $includeEmbeds,
    'include_owners' => $includeOwners,
    'include_parents' => $includeParents,
    'excluded_nodes' => $excludedNodes,
);
if ($fileStorage) {
    $options['file_storage'] = $fileStorage;
}

// Login as admin user to make sure we have access to all content
$adminUser = \eZUser::fetch(14);
if ($adminUser) {
    $adminUser->loginCurrent();
}

$query = new \Aplia\Content\Query\QuerySet(array(
    // Disable roles to get all nodes
    'useRoles' => false,
));
if ($classNames) {
    $query = $query->classes($classNames);
}
if ($parentNode) {
    $query = $query->parentNode($parentNode);
    $options['start_depth'] = $parentNode->attribute('depth');
}
if ($depth) {
    $query = $query->depth($depth);
}
$query = $query->visibility($onlyVisible);
$prettyPrint = true;

$exportChoices = array(
    'content_classes' => $classNames,
    'parent' => array(
        'node_id' => (int)$parentNode->attribute('id'),
        'node_uuid' => $parentNode->remoteId(),
        'object_id' => (int)$parentNode->attribute('contentobject_id'),
        'object_uuid' => $parentNode->object()->remoteId(),
        'path' => $parentNode->attribute('path_identification_string'),
        'url_alias' => $parentNode->urlAlias(),
        'name' => $parentNode->getName(),
    ),
    'content_languages' => $languages,
    'depth' => $depthChoice,
    'visibility' => $onlyVisible ? 'visible' : 'visible+hidden',
);
if ($format === "line") {
    if ($includeParent) {
        echo $parentNode->attribute('name'), " - ", $parentNode->className(), " (", $parentNode->attribute('contentobject_id'), ")\n";
    }
    foreach ($query as $node) {
        echo $node->attribute('name'), " - ", $node->className(), " (", $node->attribute('contentobject_id'), ")\n";
    }
} else if ($format === "ndjson") {
    $exporter = new \Aplia\Content\ContentExporter($options);
    if ($includeParent) {
        $exporter->addNode($parentNode);
    }
    if ($depth !== 0) {
        $exporter->addQuery($query);
    }
    $exporter->finalize();
    $index = $exporter->createIndex();
    $index['export'] = $exportChoices;
    echo \Aplia\Formats\NdJson::encode($index);
    foreach ($exporter->getExportItems() as $exportItems) {
        foreach ($exportItems as $exportItem) {
            echo \Aplia\Formats\NdJson::encode($exportItem);
        }
    }
    // TODO: encode export items
} else if ($format === "json") {
    $exporter = new \Aplia\Content\ContentExporter($options);
    if ($includeParent) {
        $exporter->addNode($parentNode);
    }
    if ($depth !== 0) {
        $exporter->addQuery($query);
    }
    $exporter->finalize();
    $data = array(
        '__type__' => 'ez_content_bundle',
        'export_date' => (new \DateTime())->format(\DateTime::RFC3339),
        'export' => $exportChoices,
        'types' => $exporter->createTypeList(),
        'type_counts' => $exporter->createTypeCountList(),
    );
    $data = array_merge($data, $exporter->getExportItems());
    echo \Aplia\Formats\Json::encode($data, $prettyPrint), "\n";
} else if($format === "php") {

    if ($phpPreamble) {
        echo <<<'EOT'
<?php


EOT;

        if ($useNamespace) {
            echo <<<'EOT'
use Aplia\Content\ContentType;


EOT;
        }

    echo <<<'EOT'
require 'config.php';
require 'autoload.php';

$cli = \eZCLI::instance();
$script = \eZScript::instance(
    array(
        'description' =>
            "Defines content object definitions",
        'use-session' => false,
        'use-modules' => true,
        'use-extensions' => true,
    )
);
$script->startup();
$options = $script->getOptions("", "", array());
$script->initialize();
$db = \eZDB::instance();
$db->begin();


EOT;
    } // end if preamble

    $exporter = new \Aplia\Content\ContentExporter($options);
    if ($includeParent) {
        $exporter->addNode($parentNode);
    }
    if ($depth !== 0) {
        $exporter->addQuery($query);
    }
    $exporter->finalize();
    $data = array(
        '__type__' => 'ez_content_bundle',
        'export_date' => (new \DateTime())->format(\DateTime::RFC3339),
        'export' => $exportChoices,
        'types' => $exporter->createTypeList(),
    );
    $data = array_merge($data, $exporter->getExportItems());

    $contentTypeClass = '\\Aplia\\Content\\ContentType';
    $initializedClasses = array();

    if (!isset($data['content_objects'])) {
        $data['content_objects'] = array();
    }
    foreach ($data['content_objects'] as $contentObjectId => $contentObject) {
        $objectAttributes = (isset($contentObject['attributes']) && count($contentObject['attributes'])) ? $contentObject['attributes'] : array();

        if (isset($contentObject['class_identifier']) and isset($contentObject['name'])) {
            $params = array();
            if (isset($contentObject['uuid'])) {
                $params['uuid'] = $contentObject['uuid'];
            }
            $objectName = $contentObject['name'];
            $uuidString = isset($params['uuid']) ? ", uuid: ".$params['uuid'] : "";
            $className = $contentObject['class_identifier'];
            $classNameRepr = "\$" . underscoreToCamelCase($className) . "Type";
            $objectNameRepr = "\$" . lcfirst(str_replace(" ", "", trim($objectName))) . ucfirst(underscoreToCamelCase($className));

            if (isset($initializedClasses[$className])) {
                $initializedClasses[$className][] = $objectName.$uuidString;
            } else {
                $initializedClasses[$className] = array($objectName.$uuidString);
                echo "\n${classNameRepr} = new ${contentTypeClass}('${className}');\n";
            }

            echo "${objectNameRepr} = ${classNameRepr}->contentObject(\n" . indentTextLines(var_export($params, true))."\n)\n";

            if (isset($contentObject['locations'])) {
                $params['locations'] = array();
                foreach ($contentObject['locations'] as $nodeId => $contentNode) {
                    if (isset($contentNode['parent_node_uuid'])) {
                        $locationFields = array(
                            'parent_uuid' => $contentNode['parent_node_uuid'],
                            'uuid' => $contentNode['uuid'],
                        );
                        $treeIdentifier = \Aplia\Content\ContentObject::mapNodeToTreeIdentifier($contentNode['node_id']);
                        if ($treeIdentifier) {
                            $locationFields['tree_identifier'] = $treeIdentifier;
                        }
                        $parentTreeIdentifier = \Aplia\Content\ContentObject::mapNodeToTreeIdentifier($contentNode['parent_node_id']);
                        if ($parentTreeIdentifier) {
                            $locationFields['parent_tree_identifier'] = $parentTreeIdentifier;
                        }
                        $locationData = indentTextLines(var_export($locationFields, true));
                        echo "    ->addLocation($locationData)\n";
                    } else {
                        $script->shutdown(1, "Parent node uuid not defined in content object $contentObjectId");
                    }
                }
            }

            if (isset($contentObject['translations']['nor-NO']['attributes'])) {
                $objectAttributes = array_merge($objectAttributes, $contentObject['translations']['nor-NO']['attributes']);
            }

            if ($objectAttributes) {
                foreach ($objectAttributes as $attrIdentifier => $attribute) {
                    if ($attribute && (isset($attribute['found']) ? $attribute['found'] : true)) {
                        echo "    ->setAttribute(" . var_export($attrIdentifier, true) . ", " . var_export($attribute, true) . ")\n";
                    }
                }
            }

            echo "    ->create();\n\n";
        } else {
            $script->shutdown(1, "Class identifier or name not set for content object id ".$contentObjectId);
        }

    }

    if ($summary) {
        echo "// Added content: \n".commentTextLines(indentTextLines(var_export($initializedClasses, true)));
    }

    if ($phpPreamble) {
        echo <<<'EOT'


$db->commit();
$script->shutdown();

EOT;
    } // end if preamble
} else {
    $script->shutdown(1, "Unknown format $format");
}

$script->shutdown();
